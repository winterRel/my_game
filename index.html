<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title> 贪吃蛇（面向对象版）</title>
<style type="text/css">
html,body{overflow:hidden;}
body,div,p{margin:0;padding:0;}
body{background:#000;font:12px/1.5 arial;color:#7A7A7A;}
a{text-decoration:none;outline:none;}
#tips,#copyright{position:absolute;width:100%;height:50px;text-align:center;background:#171717;border:2px solid #484848;}
#tips{top:0;border-width:0 0 2px;}
#tips a{font:14px/30px arial;color:#FFF;background:#F06;display:inline-block;margin:10px 5px 0;padding:0 15px;border-radius:15px;}
#tips a.active{background:#FE0000;}
#copyright{bottom:0;line-height:50px;border-width:2px 0 0;}
#copyright a{color:#FFF;background:#7A7A7A;padding:2px 5px;border-radius:10px;}
#copyright a:hover{background:#F90;}
#box{background:#eee;width: 100%;height: 720px;margin: 50px 0px;}
p{position:absolute;top:55px;width:100%;text-align:center;}
#box #panle{width: 100%;height: 93%;padding-top: 30px;}
#panle table{border-collapse: collapse; margin: 0 auto;}
#panle table td{
border: 1px solid #808080; 
width: 10px; 
height: 10px; 
font-size: 0; 
line-height: 0; 
overflow: hidden; }
.food{background: green;}
.snake{background: #555;}
</style>
<script type="text/javascript">
var fgm = {
  on: function(element, type, handler) {
    return element.addEventListener ? element.addEventListener(type, handler, false) : element.attachEvent("on" + type, handler)
  },
  un: function(element, type, handler) {
    return element.removeEventListener ? element.removeEventListener(type, handler, false) : element.detachEvent("on" + type, handler)
  },
  bind: function(object, handler) {
    return function() {
      return handler.apply(object, arguments) 
    } 
  },
  randomRange: function(lower, upper) {
    return Math.floor(Math.random() * (upper - lower + 1) + lower)  
  },
  getRanColor: function() {
    var str = this.randomRange(0, 0xFFFFFF).toString(16);
    while(str.length < 6) str = "0" + str;
    return "#" + str  
  },
  has:function(a,arry){
   var flag = false;
   for(var i = 0; i < arry.length; i++){
      if(fgm.equal(a,arry[i])){
        flag  = true;
      }
   }
   return flag;
  },
  equal:function(a,b)
  {
    return a.x == b.x && a.y == b.y;
  },
  cast:function(m,n)
  {
    // m进制 n 待转换参数
    if(typeof(n) === "object"){
      // 转换成10进制
      return n.x * m + n.y;
    }else{
      // 转换成m进制
      var y = n % m;
      var x = (n/m) % m;
      return {"x":x,"y":y} 
    }
  }
};
//初始化对象
function Snake() {
    this.map = 30;    // 地图大小
    this.speed = 500;   // 速度
  this.fnInit = fgm.bind(this, this.initialize)
}
Snake.prototype = {
  initialize:function(obj)
  { 
    this.oParent = obj;
    this.space = [];
    this.type = 0;  //0暂停 1开始 2失败
    this.timer = null;
    this.score = 0;   // 速度
    this.direction = 3; // 0 1 2 3 - 上 下 左 右 默认开始向右跑
    this.snake = [{"x":0,"y":0}];  // 蛇身体
    this.food = null; // 食物
    this.__create__();
  },
  __create__:function()
  {
    var oThis = this;
    this.tab = this.oParent.getElementsByTagName("table")[0];
    this.tab && (this.oParent.removeChild(this.tab));
    this.tab = document.createElement("table");
    var oFrag = document.createDocumentFragment();
    var i = 0;
    for(i = 0; i < this.map; i++)
    {
      var oTr = document.createElement("tr");
      for(var j = 0; j < oThis.map; j++)
      {
        var oTd = document.createElement("td");
        oTr.appendChild(oTd);
        this.space.push({"x":i,"y":j,"obj":oTd});
      }
      oFrag.appendChild(oTr);
    }
    this.tab.appendChild(oFrag);
    this.oParent.appendChild(this.tab);
    this.td = this.tab.getElementsByTagName("td");
    this.food = this.randomFood();
    this.changeSnake();
    this.changeFood();
  },
  start:function()
  { 
    var oThis = this;
    fgm.on(document,"keydown",function(event){
      var e = event || window.event;
      switch(e.keyCode)
      {
        case 37: // left 2 
          if(oThis.direction == 0 || oThis.direction == 1){
            oThis.direction = 2;
          } 
        break;
        case 38: // up 0 
          if(oThis.direction == 2 || oThis.direction == 3){
            oThis.direction = 0;
          } 
        break;
        case 39: // right 3
          if(oThis.direction == 0 || oThis.direction == 1){
            oThis.direction = 3;
          } 
        break;
        case 40: // down 1
          if(oThis.direction == 2 || oThis.direction == 3){
            oThis.direction = 1;
          } 
        break;
      }
      //console.log(oThis.direction)
    });
    oThis.doMove(this.speed);
  },
  doMove:function(ispeed,fn)
  {
    clearInterval(this.timer);
    var oThis = this;
    this.timer = setInterval(function(){
      var next = oThis.nextFn();
      if(fgm.equal(next,oThis.food)){
        oThis.snake.unshift(oThis.food);
        oThis.food = oThis.randomFood();
        oThis.changeFood();
        oThis.changeSnake();
        next = oThis.nextFn();
        oThis.score++;
      }
      oThis.faild(next) && (clearInterval(oThis.timer),alert("GAME OVER YOUR SCORE IS "+oThis.score));
      oThis.snake.unshift(next);
      oThis.snake.pop();
      oThis.changeSnake();
    },oThis.speed)
  },
  faild:function(a)
  {
    var wall = false;
    var bite = false;
    switch(this.direction)
    {
      case 3:
        a.y >= this.map && (wall = true);
      break;
      case 1:
        a.x >= this.map && (wall = true);
      break;
      case 2:
        a.y < 0 && (wall = true);
      break;
      case 0:
        a.x < 0 && (wall = true);
      break;
    } 
    bite = fgm.has(a,this.snake);
    return wall || bite;
  },
  nextFn:function()
  { 
    var x,y = 0;
    var oThis = this;
    this.direction == 3 &&( x = this.snake[0].x ,y = this.snake[0].y + 1);
    this.direction == 1 &&( x = this.snake[0].x + 1 ,y = this.snake[0].y);
    this.direction == 2 &&( x = this.snake[0].x ,y = this.snake[0].y - 1);
    this.direction == 0 &&( x = this.snake[0].x - 1 ,y = this.snake[0].y);
    var a = {"x":x,"y":y};
    return a;
  },
  randomFood:function()
  {
    var a = {"x":fgm.randomRange(1,this.map-1),"y":fgm.randomRange(1,this.map-1)};
    if(fgm.has(a,this.snake)){
      this.food();
    }else{
      return a;
    }
  },
  changeSnake:function()
  { 
    var oThis = this;
    for(var i = 0; i < this.space.length; i++)this.space[i].obj.className = "";
    for(var i = 0; i < this.snake.length; i++){
     this.space[fgm.cast(oThis.map,oThis.snake[i])].obj.className = "snake";
    }
    this.changeFood();
  },
  changeFood:function()
  {
    this.space[fgm.cast(this.map,this.food)].obj.className = "food";
  },
  stop:function()
  {
    this.timer && clearInterval(this.timer);
  }
};

fgm.on(window, "load", function() {
  var oTips = document.getElementById("tips");
  var aBtn = oTips.getElementsByTagName("a");
  var select = oTips.getElementsByTagName("select");
  var panle = document.getElementById("panle");
  var snake = new Snake();
  fgm.on(oTips, "click", function(event) {
    var oEvent = event || window.event;
    var oTarget = oEvent.target || oEvent.srcElement;
    var i = 0;
    if(oTarget.tagName.toUpperCase() == "A") {
      for(i = 0; i < aBtn.length; i++) aBtn[i].className = "";
      switch(oTarget.id) {
        case "start":
          snake.type = 1;
          snake.start();
          for(var j = 0; j < select.length; j++){
            select[j].disabled = true;
          }
          break;
        case "stop":
          snake.type = 0;
          snake.stop();
          break;
      }
      oTarget.className = "active";         
      oEvent.stopPropagation ? oEvent.stopPropagation() : oEvent.cancelBubble = true
    }
  });
  fgm.on(select[0],"change",function(){
    snake.map = select[0].value;
    snake.initialize(panle);
  });
  fgm.on(select[1],"change",function(){
    snake.speed = select[1].value;
    snake.initialize(panle);
  });
  snake.initialize(panle);
});
fgm.on(document, "contextmenu", function(event) {
  var oEvent = event || window.event;
  oEvent.preventDefault ? oEvent.preventDefault() : oEvent.returnValue = false
});
</script>
</head>
<body>
<div id="tips"><a id="start" href="javascript:;">开始游戏</a><a id="stop" href="javascript:;">停止游戏</a>
  <select id="map">
    <option value = "30">30 * 30</option>
    <option value = "40">40 * 40</option>
    <option value = "50">50 * 50</option>
  </select>
  <select id="speed">
    <option value = "500">速度 - 慢</option>
    <option value = "300">速度 - 中</option>
    <option value = "200">速度 - 快</option>
  </select>
  <p>游戏使用键盘“上下左右”控制，点击开始游戏开始</p>
</div>

<div id="box">

<div id="panle">
</div>
</div>
<div id="copyright">建议使用Firefox, Chrome浏览器预览效果. 如蒙转载请注明出处 <a href="http://weibo.com/3839963356/profile?topnav=1&wvr=6&is_all=1">winter</a> , By — ben, QQ:1583145833</div>
</body>
</html>
